<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel='stylesheet' href='https://code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css'>
    <script src='https://code.jquery.com/jquery-1.12.4.js'></script>
    <script src='https://code.jquery.com/ui/1.12.1/jquery-ui.js'></script>
    <script>
        const url = 'https://8fd0-181-231-122-56.ngrok-free.app/student';

        window.onload = function() {
            $('#popUp').hide();
            getStudents();
        }

        //Promesas

        function loadStudents() {
            return new Promise(function(resolve, reject) {
                var request = new XMLHttpRequest();
                request.open('GET', url + '/getAll');
                request.responseType = 'json';
                request.onload = function() {
                    if(request.status == 200){
                        resolve(request.response);
                    } else{
                        reject(Error(request.statusText));
                    }
                }
                request.onerror = function() {
                    reject(Error("Error network"));
                }
                request.send();
            });
        }

        function addStudent() {
            return new Promise(function(resolve, reject) {
                var request = new XMLHttpRequest();
                request.open('POST', url);
                request.setRequestHeader('Content-Type', 'application/json');
                var student = JSON.stringify({
                    'dni': document.getElementById('dni').value,
                    'lastName': document.getElementById('lastName').value,
                    'firstName': document.getElementById('firstName').value,
                    'email': document.getElementById('email').value,
                    'cohort': '0',
                    'status': 'activo',
                    'gender': 'masculino',
                    'address': 'abc123',
                    'phone': '000'
                });
                request.onload = function() {
                    if(request.status == 201) {
                        resolve(request.response);
                    }else {
                        reject(Error(request.statusText));
                    }
                }
                request.onerror = function() {
                    reject(Error('Error: unexpected network error.'))
                }
                request.send(student);
            })
        }
        
        function removeStudent(id) {
            return new Promise (function(resolve, reject) {
                var request = new XMLHttpRequest();
                request.open('POST', url +`/${id}/delete`);
                request.setRequestHeader('Content-Type', 'application/json');
                request.onload = function() {
                    if(request.status == 200) {
                        resolve(request.response);
                    } else {
                        reject(Error(request.statusText));
                    }
                };
                request.onerror = function() {
                    reject(Error('Error: unexpected network error.'));
                };
                request.send();            
            });
        }

        function modifyStudent() {
            return new Promise(function(resolve, reject) {
                var request = new XMLHttpRequest();
                request.open('POST', url + `/${document.getElementsByName('id2')[0].value}/update`);
                request.setRequestHeader('Content-Type', 'application/json');
                var student = JSON.stringify({
                    'dni': document.getElementsByName('dni2')[0].value,
                    'lastName': document.getElementsByName('lastName2')[0].value,
                    'firstName': document.getElementsByName('firstName2')[0].value,
                    'email': document.getElementsByName('email2')[0].value,
                    'cohort': '0',
                    'status': 'activo',
                    'gender': 'masculino',
                    'address': 'abc123',
                    'phone': '000'
                });
                request.onload = function() {
                    if(request.status == 200) {
                        resolve(request.response);
                    } else {
                        reject(Error(request.statusText));
                    }
                };
                request.onerror = function() {
                    reject(Error('Error: unexpected network error.'));
                };
                request.send(student);
            })
        }
      

        //Funciones que consumen las promesas

        function getStudents() {
            loadStudents().then(response => {
                    var tbody = document.querySelector('tbody');
                    tbody.innerHTML = '';
                    var contador = 0;
                    response.forEach(e => {
                        contador++;
                        var row = tbody.insertRow();
                        var id = row.insertCell();
                        id.innerHTML = e.id;
                        var dni = row.insertCell();
                        dni.setAttribute('name', 'dni')
                        dni.innerHTML = e.dni;
                        var lastName = row.insertCell();
                        lastName.innerHTML = e.lastName;
                        var firstName = row.insertCell();
                        firstName.innerHTML = e.firstName;
                        var email = row.insertCell();
                        email.innerHTML = e.email;
                        var student = JSON.stringify({
                            'id': e.id,
                            'dni': e.dni,
                            'lastName': e.lastName,
                            'firstName': e.firstName,
                            'email': e.email,
                        })
                        var view = row.insertCell();
                        view.innerHTML = `<button onclick='viewStudent(${student})'>View</button>`;
                        var del = row.insertCell();
                        del.innerHTML = `<button onclick='deleteStudent(${e.id})'>Delete</button>`;
                    });

                    var total = document.getElementById('cantAlumnos');
                    total.innerHTML = `Cantidad total de alumnos: ${contador}`;

                    document.getElementById('dni').value = '';
                    document.getElementById('lastName').value = '';
                    document.getElementById('firstName').value = '';
                    document.getElementById('email').value = '';
                    document.getElementById('dni').focus();
                })
                .catch((reason) => {
                    console.log(Error(reason))
                });
        };
        
        function saveStudent() {
            if (document.getElementById('dni').value.trim() !== '' &&
                document.getElementById('lastName').value.trim() !== '' &&
                document.getElementById('firstName').value.trim() !== '' &&
                document.getElementById('email').value.trim() !== '') {
                    addStudent().then(() => {
                        getStudents();
                    }).catch(reason => {
                        console.error(reason);
                    });
                }
        }

        function deleteStudent(id) {
            removeStudent(id).then(() => {
                if ($('#popUp').is(':visible')) {
                    $('#popUp').dialog('close');
                }
                getStudents();
            }).catch(reason => {
                console.error(reason);
            });
        };

        function viewStudent(student) {
            document.getElementsByName('id2')[0].value = student.id;
            document.getElementsByName('dni2')[0].value = student.dni;
            document.getElementsByName('lastName2')[0].value = student.lastName;
            document.getElementsByName('firstName2')[0].value = student.firstName;
            document.getElementsByName('email2')[0].value = student.email;
            $('#popUp').dialog({
                closeText: ''
            }).css ('font-size', '15px');
        };

        function updateStudent() {
            if (document.getElementsByName('dni2')[0].value.trim() !== '' &&
                document.getElementsByName('lastName2')[0].value.trim() !== '' &&
                document.getElementsByName('firstName2')[0].value.trim() !== '' &&
                document.getElementsByName('email2')[0].value.trim() !== '') {
                modifyStudent().then(() => {
                    $('#popUp').dialog('close');
                    getStudents();
                }).catch(reason => {
                    console.error(reason);
                });
            }
        }

        function searchByDni(dni) {
            var tbody = document.getElementsByTagName('tbody')[0];
            var encontrado = false;
            for(i = 0; i < tbody.rows.length && !encontrado; i++) {
                if(tbody.rows[i].cells[1].innerHTML == dni) {
                    document.getElementsByName('id2')[0].value = tbody.rows[i].cells[0].innerHTML;
                    document.getElementsByName('dni2')[0].value = tbody.rows[i].cells[1].innerHTML;
                    document.getElementsByName('lastName2')[0].value = tbody.rows[i].cells[2].innerHTML;
                    document.getElementsByName('firstName2')[0].value = tbody.rows[i].cells[3].innerHTML;
                    document.getElementsByName('email2')[0].value = tbody.rows[i].cells[4].innerHTML;
                    $('#popUp').dialog({
                        closeText: ''
                    }).css ('font-size', '15px');
                    encontrado = true;
                };
            };
            document.getElementById('searchDni').value = '';
            if(!encontrado) {
                    alert('El DNI ingresado no existe en la base de datos');
                }
        };

    </script>
</head>
<body>
    <table style='border: 1px solid'>
        <thead>
            <tr>
                <th style='text-align: left'>Id</th>
                <th style='text-align: left'>DNI</th>
                <th style='text-align: left'>Last Name</th>
                <th style='text-align: left'>First Name</th>
                <th style='text-align: left'>Email</th>
                <th colspan='2'></th>
            </tr>
        </thead>
        <tbody>      
        </tbody>
        <tfoot>
            <tr>
                <td></td>
                <td><input id="dni" /></td>
                <td><input id="lastName" /></td>
                <td><input id="firstName" /></td>
                <td><input id="email" /></td>
                <td colspan='2' style='text-align: center'><button onclick="saveStudent()">Add</button></td>
            </tr>
        </tfoot>
    </table>
    <h3 id="cantAlumnos">Cantidad de alumnos: </h3>
    <div id="search">
        <h1><input id="searchDni" style="text-align: right"></h1>
        <h1 style="text-align: left"><button onclick="searchByDni(document.getElementById('searchDni').value)">Search Student</button></h1>
    </div>
    <div id="popUp">
        <table>
            <tr>
                <td><label for="id2" style="font-weight: bold">Id</label></td>
                <td><input name="id2" style="text-align: right" readonly /></td>
            </tr>
            <tr>
                <td><label for="dni2" style="font-weight: bold">Dni</label></td>
                <td><input name="dni2" style="text-align: right" /></td>
            </tr>
            <tr>
                <td><label for="lastName2" style="font-weight: bold">Last Name</label></td>
                <td><input name="lastName2" style="text-align: right" /></td>
            </tr>
            <tr>
                <td><label for="firstName2" style="font-weight: bold">First Name</label></td>
                <td><input name="firstName2" style="text-align: right" /></td>
            </tr>
            <tr>
                <td><label for="email2" style="font-weight: bold">Email</label></td>
                <td><input name="email2" style="text-align: right" /></td>
            </tr>
            <tr>
                <td style="text-align: right"><button onclick="updateStudent()">Update</button></td>
                <td style="text-align: left;"><button onclick="deleteStudent(document.getElementsByName('id2')[0].value)">Delete</button></td>
            </tr>
        </table>
    </div>
</body>
</html>